<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
  <title>Register - Surabhi Premier League 2025</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      background: #0f172a;
      color: #e2e8f0;
      font-family: system-ui, Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .container {
      max-width: 600px;
      width: 100%;
      background: #111827;
      border: 2px solid #334155;
      border-radius: 16px;
      padding: clamp(20px, 4vw, 40px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      font-size: clamp(24px, 5vw, 36px);
      margin-bottom: 10px;
      color: #60a5fa;
      font-weight: 700;
      text-align: center;
    }
    
    .subtitle {
      text-align: center;
      color: #94a3b8;
      margin-bottom: 30px;
      font-size: clamp(14px, 2.5vw, 16px);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #e2e8f0;
      font-weight: 500;
      font-size: clamp(14px, 2.5vw, 16px);
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      background: #1e293b;
      border: 2px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 16px;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #60a5fa;
    }
    
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .submit-btn {
      width: 100%;
      padding: 16px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
      margin-top: 10px;
    }
    
    .submit-btn:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.3);
    }
    
    .back-link {
      display: inline-block;
      margin-top: 20px;
      color: #60a5fa;
      text-decoration: none;
      font-size: 14px;
      text-align: center;
      width: 100%;
    }
    
    .back-link:hover {
      text-decoration: underline;
    }
    
    .help-text {
      display: block;
      margin-top: 5px;
      font-size: 12px;
      color: #94a3b8;
    }
    
    .photo-preview {
      margin-top: 10px;
      display: none;
    }
    
    .photo-preview img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      border: 2px solid #334155;
      margin-top: 10px;
    }
    
    .confirmation-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .confirmation-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .confirmation-box {
      background: #111827;
      border: 2px solid #334155;
      border-radius: 16px;
      padding: 30px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    }
    
    .confirmation-title {
      font-size: 24px;
      color: #60a5fa;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .confirmation-details {
      background: #1e293b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .confirmation-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #334155;
    }
    
    .confirmation-row:last-child {
      border-bottom: none;
    }
    
    .confirmation-label {
      font-weight: 600;
      color: #94a3b8;
      flex: 0 0 40%;
    }
    
    .confirmation-value {
      color: #e2e8f0;
      flex: 1;
      text-align: right;
    }
    
    .confirmation-photo {
      text-align: center;
      margin: 20px 0;
    }
    
    .confirmation-photo img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      border: 2px solid #334155;
    }
    
    .confirmation-fee {
      background: #10b981;
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      margin: 20px 0;
    }
    
    .confirmation-buttons {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }
    
    .confirmation-btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-confirm {
      background: #10b981;
      color: white;
    }
    
    .btn-confirm:hover {
      background: #059669;
      transform: translateY(-2px);
    }
    
    .btn-back {
      background: #3b82f6;
      color: white;
    }
    
    .btn-back:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }
    
    .photo-preview.active {
      display: block;
    }
    
    .error-message {
      color: #ef4444;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    
    .error-message.show {
      display: block;
    }
    
    input:invalid {
      border-color: #ef4444;
    }
    
    input:valid {
      border-color: #10b981;
    }
    
    .fee-display {
      padding: 12px 16px;
      background: #1e293b;
      border: 2px solid #10b981;
      border-radius: 8px;
      color: #10b981;
      font-size: 20px;
      font-weight: 700;
      text-align: center;
    }
    
    .check-note {
      background: #fef3c7;
      color: #92400e;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      border: 2px solid #fbbf24;
    }
    
    .success-page {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0f172a;
      z-index: 2000;
      overflow-y: auto;
      padding: 20px;
    }
    
    .success-container {
      max-width: 800px;
      margin: 0 auto;
      background: #111827;
      border: 2px solid #334155;
      border-radius: 16px;
      padding: clamp(20px, 4vw, 40px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    }
    
    .success-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .success-icon {
      width: 80px;
      height: 80px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 50px;
      color: white;
      font-weight: bold;
    }
    
    .success-header h1 {
      color: #10b981;
      font-size: clamp(24px, 5vw, 36px);
      margin-bottom: 10px;
    }
    
    .success-subtitle {
      color: #94a3b8;
      font-size: clamp(14px, 2.5vw, 18px);
    }
    
    .success-details {
      background: #1e293b;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
    }
    
    .success-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 15px 0;
      border-bottom: 1px solid #334155;
    }
    
    .success-detail-row:last-child {
      border-bottom: none;
    }
    
    .success-detail-label {
      font-weight: 600;
      color: #94a3b8;
      flex: 0 0 40%;
    }
    
    .success-detail-value {
      color: #e2e8f0;
      flex: 1;
      text-align: right;
    }
    
    .success-detail-value.orn {
      color: #60a5fa;
      font-size: 20px;
      font-weight: 700;
    }
    
    .success-detail-value.fee {
      color: #10b981;
      font-size: 18px;
      font-weight: 700;
    }
    
    .payment-instructions {
      background: #1e293b;
      border: 2px solid #fbbf24;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
    }
    
    .payment-instructions h3 {
      color: #fbbf24;
      margin-bottom: 15px;
      font-size: clamp(18px, 3vw, 24px);
    }
    
    .payment-note {
      background: #fef3c7;
      color: #92400e;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .payment-contacts {
      color: #e2e8f0;
    }
    
    .payment-contacts p {
      margin-bottom: 15px;
      font-weight: 600;
    }
    
    .contact-item {
      padding: 10px 0;
      font-size: clamp(14px, 2.5vw, 16px);
    }
    
    .contact-item strong {
      color: #60a5fa;
    }
    
    .contact-item a {
      color: #10b981;
      text-decoration: none;
      margin-left: 10px;
    }
    
    .contact-item a:hover {
      text-decoration: underline;
    }
    
    .success-actions {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .download-btn {
      width: 100%;
      padding: 16px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
    }
    
    .download-btn:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.3);
    }
    
    .new-registration-btn, .home-btn {
      display: block;
      text-align: center;
      padding: 14px;
      background: #334155;
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .new-registration-btn:hover, .home-btn:hover {
      background: #475569;
      transform: translateY(-2px);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }
    
    .modal-content {
      background: #111827;
      border: 2px solid #334155;
      border-radius: 16px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-content h2 {
      color: #60a5fa;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .confirmation-details {
      background: #1e293b;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .confirmation-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #334155;
    }
    
    .confirmation-row:last-child {
      border-bottom: none;
    }
    
    .confirmation-label {
      font-weight: 600;
      color: #94a3b8;
      flex: 0 0 40%;
    }
    
    .confirmation-value {
      color: #e2e8f0;
      flex: 1;
      text-align: right;
    }
    
    .confirmation-photo {
      text-align: center;
      margin-top: 15px;
    }
    
    .confirmation-photo img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      border: 2px solid #334155;
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }
    
    .btn-confirm, .btn-back {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-confirm {
      background: #10b981;
      color: white;
    }
    
    .btn-confirm:hover {
      background: #059669;
      transform: translateY(-2px);
    }
    
    .btn-back {
      background: #3b82f6;
      color: white;
    }
    
    .btn-back:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }
    
    @media (max-width: 768px) {
      .modal-content {
        padding: 20px;
      }
      
      .confirmation-row {
        flex-direction: column;
      }
      
      .confirmation-value {
        text-align: left;
        margin-top: 5px;
      }
      
      .modal-buttons {
        flex-direction: column;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 20px;
      }
      
      input, select, textarea {
        font-size: 16px; /* Prevents zoom on iOS */
      }
      
      .success-detail-row {
        flex-direction: column;
        gap: 5px;
      }
      
      .success-detail-value {
        text-align: left;
      }
      
      .success-detail-value.orn {
        font-size: 18px;
      }
      
      .payment-contacts {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Register for Surabhi Premier League 2025</h1>
    <p class="subtitle">Fill in your details to register</p>
    
    <form id="registrationForm" enctype="multipart/form-data">
      <div class="form-group">
        <label for="name">Name *</label>
        <input type="text" id="name" name="name" pattern="[A-Za-z\s]+" title="Only alphabets and spaces are allowed" required>
        <small class="help-text">Only alphabets and spaces allowed</small>
      </div>
      
      <div class="form-group">
        <label for="fatherName">Father Name *</label>
        <input type="text" id="fatherName" name="fatherName" pattern="[A-Za-z\s]+" title="Only alphabets and spaces are allowed" required>
        <small class="help-text">Only alphabets and spaces allowed</small>
      </div>
      
      <div class="form-group">
        <label for="category">Category *</label>
        <select id="category" name="category" required>
          <option value="">Select category</option>
          <option value="Batsman">Batsman</option>
          <option value="All-Rounder">All-Rounder</option>
          <option value="Bowler">Bowler</option>
          <option value="Keeper">Keeper</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="mobile">Mobile Number *</label>
        <input type="tel" id="mobile" name="mobile" pattern="[0-9]{10}" title="Enter exactly 10 digits" maxlength="10" required>
        <small class="help-text">Enter 10 digit mobile number</small>
      </div>
      
      <div class="form-group">
        <label for="captaincy">Captaincy *</label>
        <select id="captaincy" name="captaincy" required>
          <option value="">Select</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>
      
      <div class="form-group" id="registrationFeeGroup" style="display: none;">
        <label>Registration Fee</label>
        <div class="fee-display" id="registrationFee">‚Çπ0</div>
        <small class="help-text">Fee: ‚Çπ2000 for Captaincy, ‚Çπ500 otherwise</small>
      </div>
      
      <div class="form-group">
        <label for="jerseyName">Name on Jersey *</label>
        <input type="text" id="jerseyName" name="jerseyName" pattern="[A-Za-z\s]+" title="Only alphabets and spaces are allowed" required>
        <small class="help-text">Only alphabets and spaces allowed</small>
      </div>
      
      <div class="form-group">
        <label for="jerseyNumber">Jersey Number *</label>
        <input type="text" id="jerseyNumber" name="jerseyNumber" pattern="[0-9]+" title="Only numbers are allowed" maxlength="3" required>
        <small class="help-text">Only numbers allowed</small>
      </div>
      
      <div class="form-group">
        <label for="tshirtSize">T-shirt Size *</label>
        <select id="tshirtSize" name="tshirtSize" required>
          <option value="">Select T-shirt size</option>
          <option value="S">S</option>
          <option value="M">M</option>
          <option value="L">L</option>
          <option value="XL">XL</option>
          <option value="XXL">XXL</option>
          <option value="XXXL">XXXL</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="trouserSize">Trouser Size *</label>
        <select id="trouserSize" name="trouserSize" required>
          <option value="">Select trouser size</option>
          <option value="S">S</option>
          <option value="M">M</option>
          <option value="L">L</option>
          <option value="XL">XL</option>
          <option value="XXL">XXL</option>
          <option value="XXXL">XXXL</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="photo">Upload Photo *</label>
        <input type="file" id="photo" name="photo" accept="image/*,.jpg,.jpeg,.png,.gif,.webp" required>
        <small class="help-text">Supported formats: JPG, PNG, GIF, WebP. Maximum size: 10MB</small>
        <div id="photoPreview" class="photo-preview"></div>
      </div>
      
      <button type="submit" class="submit-btn">Review Registration</button>
    </form>
    
    <!-- Confirmation Overlay -->
    <div id="confirmationOverlay" class="confirmation-overlay">
      <div class="confirmation-box">
        <h2 class="confirmation-title">Confirm Registration Details</h2>
        <div class="check-note">
          <strong>‚ö†Ô∏è Please check all details carefully before confirming!</strong>
        </div>
        <div class="confirmation-details" id="confirmationDetails"></div>
        <div class="confirmation-fee" id="confirmationFee"></div>
        <div class="confirmation-buttons">
          <button class="confirmation-btn btn-back" id="goBackBtn">Go Back</button>
          <button class="confirmation-btn btn-confirm" id="confirmBtn">Confirm</button>
        </div>
      </div>
    </div>
    
    <a href="index.html" class="back-link">‚Üê Back to Home</a>
  </div>
  
  <!-- Success Page (hidden initially, outside container) -->
  <div id="successPage" class="success-page" style="display: none;">
    <div class="success-container">
      <div class="success-header">
        <div class="success-icon">‚úì</div>
        <h1>Registration Successful!</h1>
        <p class="success-subtitle">Your registration has been submitted successfully</p>
      </div>
      
      <div class="success-details" id="successDetails"></div>
      
      <div class="payment-instructions">
        <h3>Payment Instructions</h3>
        <p class="payment-note">
          <strong>Please quote your ORN number when making the payment.</strong>
        </p>
        <div class="payment-contacts">
          <p>Pay the registration fee to:</p>
          <div class="contact-item">
            <strong>Surya:</strong> <a href="tel:7036216447">7036216447</a>
          </div>
          <div class="contact-item">
            <strong>Sai Subhakar:</strong> <a href="tel:8985182185">8985182185</a>
          </div>
        </div>
      </div>
      
      <div class="success-actions">
        <button id="downloadPdfBtn" class="download-btn">üì• Download Registration Details (PDF)</button>
        <a href="register.html" class="new-registration-btn">Register Another Player</a>
        <a href="index.html" class="home-btn">‚Üê Back to Home</a>
      </div>
    </div>
  </div>
  
  <script>
    // Google Sheets configuration
    //const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxBPR-onenOPpruhW6gtr0GkyX4p6o_pt4k7OTADa7WEgl0Ph4toB5KDZdcERUakUtZ/exec'; // Will be set after deploying Apps Script
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxY-Hoq9xCwO2i_rixEmDzThNVe8m4yDLWhAewhM9Vs8fq4TFYbNRAff87-0E9sR2NQ/exec';
    
    // Store registration data for success page
    let registrationData = null;
    
    // Flag to track if we've received postMessage (to prevent duplicate processing)
    let postMessageReceived = false;
    
    // Listen for postMessage from iframe (Google Apps Script response)
    // This avoids CORS issues when reading iframe content
    window.addEventListener('message', function(event) {
      // Verify message is from Google Apps Script (script.google.com)
      if (event.origin.includes('script.google.com') || event.origin.includes('script.googleusercontent.com')) {
        if (event.data && event.data.type === 'registration-success' && !postMessageReceived) {
          postMessageReceived = true;
          console.log('‚úÖ Received postMessage from Google Apps Script:', event.data);
          const orn = event.data.orn || null;
          
          // Find the confirmation button to restore its state
          const confirmBtn = document.querySelector('#confirmationOverlay .confirm-btn');
          const originalText = confirmBtn ? confirmBtn.textContent : 'Confirm Registration';
          
          const successData = {
            name: pendingFormData ? pendingFormData.name : '',
            fatherName: pendingFormData ? pendingFormData.fatherName : '',
            category: pendingFormData ? pendingFormData.category : '',
            mobile: pendingFormData ? pendingFormData.mobile : '',
            captaincy: pendingFormData ? pendingFormData.captaincy : '',
            registrationFee: pendingFormData ? pendingFormData.registrationFee : '500',
            jerseyName: pendingFormData ? pendingFormData.jerseyName : '',
            jerseyNumber: pendingFormData ? pendingFormData.jerseyNumber : '',
            tshirtSize: pendingFormData ? pendingFormData.tshirtSize : '',
            trouserSize: pendingFormData ? pendingFormData.trouserSize : '',
            photoPreview: pendingPhotoPreview || null
          };
          
          document.getElementById('confirmationOverlay').classList.remove('active');
          document.getElementById('registrationForm').reset();
          document.getElementById('photoPreview').classList.remove('active');
          document.getElementById('photoPreview').innerHTML = '';
          document.getElementById('registrationFeeGroup').style.display = 'none';
          
          showSuccessPage(successData, orn);
          
          // Clear pending data
          pendingFormData = null;
          pendingPhotoBase64 = null;
          pendingPhotoName = null;
          pendingPhotoType = null;
          pendingPhotoPreview = null;
          
          // Reset postMessage flag after a delay
          setTimeout(() => { postMessageReceived = false; }, 5000);
        } else if (event.data && event.data.type === 'registration-error' && !postMessageReceived) {
          postMessageReceived = true;
          console.log('‚ùå Received error from Google Apps Script:', event.data);
          alert('Registration Error:\n\n' + (event.data.error || event.data.message || 'Registration failed') + '\n\nPlease correct the issue and try again.');
          document.getElementById('confirmationOverlay').classList.remove('active');
          const confirmBtn = document.querySelector('#confirmationOverlay .confirm-btn');
          if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirm Registration';
          }
          setTimeout(() => { postMessageReceived = false; }, 5000);
        }
      }
    });
    
    // Function to show success page with all details
    function showSuccessPage(data, orn) {
      try {
        console.log('showSuccessPage called with data:', data, 'orn:', orn);
        
        registrationData = { ...data, orn: orn };
        
        // Hide form container
        const container = document.querySelector('.container');
        const backLink = document.querySelector('.back-link');
        
        if (container) {
          container.style.display = 'none';
        }
        if (backLink) {
          backLink.style.display = 'none';
        }
        
        // Show success page
        const successPage = document.getElementById('successPage');
        if (!successPage) {
          console.error('Success page element not found!');
          alert('Registration successful! ORN: ' + (orn || 'Pending') + '\n\nPlease note your ORN for payment.');
          return;
        }
        
        successPage.style.display = 'block';
        console.log('Success page displayed');
        
        // Get details div
        const detailsDiv = document.getElementById('successDetails');
        if (!detailsDiv) {
          console.error('Success details div not found!');
          alert('Registration successful! ORN: ' + (orn || 'Pending') + '\n\nPlease note your ORN for payment.');
          return;
        }
        
        // Build success details HTML
        let detailsHTML = '';
        
        detailsHTML += '<div class="success-detail-row">';
        detailsHTML += '<span class="success-detail-label">Online Registration Number (ORN):</span>';
        detailsHTML += '<span class="success-detail-value orn">' + (orn || 'Pending') + '</span>';
        detailsHTML += '</div>';
        
        detailsHTML += '<div class="success-detail-row">';
        detailsHTML += '<span class="success-detail-label">Name:</span>';
        detailsHTML += '<span class="success-detail-value">' + (data.name || '') + '</span>';
        detailsHTML += '</div>';
        
        detailsHTML += '<div class="success-detail-row">';
        detailsHTML += '<span class="success-detail-label">Father Name:</span>';
        detailsHTML += '<span class="success-detail-value">' + (data.fatherName || '') + '</span>';
        detailsHTML += '</div>';
        
        detailsHTML += '<div class="success-detail-row">';
        detailsHTML += '<span class="success-detail-label">Category:</span>';
        detailsHTML += '<span class="success-detail-value">' + (data.category || '') + '</span>';
        detailsHTML += '</div>';
        
        detailsHTML += '<div class="success-detail-row">';
        detailsHTML += '<span class="success-detail-label">Mobile Number:</span>';
        detailsHTML += '<span class="success-detail-value">' + (data.mobile || '') + '</span>';
        detailsHTML += '</div>';
        
        detailsHTML += '<div class="success-detail-row">';
        detailsHTML += '<span class="success-detail-label">Captaincy:</span>';
        detailsHTML += '<span class="success-detail-value">' + (data.captaincy || '') + '</span>';
        detailsHTML += '</div>';
        
        detailsHTML += '<div class="success-detail-row">';
        detailsHTML += '<span class="success-detail-label">Registration Fee:</span>';
        detailsHTML += '<span class="success-detail-value fee">‚Çπ' + (data.registrationFee || '0') + '</span>';
        detailsHTML += '</div>';
        
        detailsHTML += '<div class="success-detail-row">';
        detailsHTML += '<span class="success-detail-label">Name on Jersey:</span>';
        detailsHTML += '<span class="success-detail-value">' + (data.jerseyName || '') + '</span>';
        detailsHTML += '</div>';
        
        detailsHTML += '<div class="success-detail-row">';
        detailsHTML += '<span class="success-detail-label">Jersey Number:</span>';
        detailsHTML += '<span class="success-detail-value">' + (data.jerseyNumber || '') + '</span>';
        detailsHTML += '</div>';
        
        detailsHTML += '<div class="success-detail-row">';
        detailsHTML += '<span class="success-detail-label">T-shirt Size:</span>';
        detailsHTML += '<span class="success-detail-value">' + (data.tshirtSize || '') + '</span>';
        detailsHTML += '</div>';
        
        detailsHTML += '<div class="success-detail-row">';
        detailsHTML += '<span class="success-detail-label">Trouser Size:</span>';
        detailsHTML += '<span class="success-detail-value">' + (data.trouserSize || '') + '</span>';
        detailsHTML += '</div>';
        
        if (data.photo && data.photoPreview) {
          detailsHTML += '<div class="success-detail-row">';
          detailsHTML += '<span class="success-detail-label">Photo:</span>';
          detailsHTML += '<span class="success-detail-value"><img src="' + data.photoPreview + '" alt="Photo" style="max-width: 100px; max-height: 100px; border-radius: 8px;"></span>';
          detailsHTML += '</div>';
        }
        
        detailsDiv.innerHTML = detailsHTML;
        console.log('Success details HTML set');
        
        // Scroll to top
        window.scrollTo(0, 0);
        console.log('Success page displayed successfully');
      } catch (error) {
        console.error('Error in showSuccessPage:', error);
        alert('Registration successful! ORN: ' + (orn || 'Pending') + '\n\nPlease note your ORN for payment.\n\nError displaying details: ' + error.message);
      }
    }
    
    // Function to download PDF
    function downloadPDF() {
      if (!registrationData) {
        alert('No registration data available to download.');
        return;
      }
      
      console.log('Generating PDF with data:', registrationData);
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Set font
      doc.setFontSize(20);
      doc.setTextColor(0, 0, 0);
      doc.text('Surabhi Premier League 2025', 105, 20, { align: 'center' });
      
      doc.setFontSize(16);
      doc.text('Registration Confirmation', 105, 30, { align: 'center' });
      
      // Draw line
      doc.setLineWidth(0.5);
      doc.line(20, 35, 190, 35);
      
      // Registration details
      let yPos = 45;
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      
      // ORN (highlighted)
      doc.setFontSize(14);
      doc.setTextColor(0, 100, 200);
      doc.setFont(undefined, 'bold');
      const ornValue = registrationData.orn && registrationData.orn !== 'Pending' ? registrationData.orn : 'Pending';
      doc.text('Online Registration Number (ORN):', 20, yPos);
      doc.text(ornValue, 120, yPos);
      yPos += 10;
      
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.setFont(undefined, 'normal');
      doc.line(20, yPos, 190, yPos);
      yPos += 10;
      
      // Other details - ensure all fields are included
      const details = [
        ['Name:', registrationData.name || ''],
        ['Father Name:', registrationData.fatherName || ''],
        ['Category:', registrationData.category || ''],
        ['Mobile Number:', registrationData.mobile || ''],
        ['Captaincy:', registrationData.captaincy || ''],
        ['Registration Fee:', '‚Çπ' + (registrationData.registrationFee || '0')],
        ['Name on Jersey:', registrationData.jerseyName || ''],
        ['Jersey Number:', registrationData.jerseyNumber || ''],
        ['T-shirt Size:', registrationData.tshirtSize || ''],
        ['Trouser Size:', registrationData.trouserSize || '']
      ];
      
      details.forEach(([label, value]) => {
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        doc.setFont(undefined, 'bold');
        doc.text(label, 20, yPos);
        doc.setFont(undefined, 'normal');
        // Wrap long text if needed
        const maxWidth = 100;
        const lines = doc.splitTextToSize(value || '', maxWidth);
        doc.text(lines, 80, yPos);
        yPos += Math.max(8, lines.length * 6);
      });
      
      // Payment instructions
      if (yPos > 250) {
        doc.addPage();
        yPos = 20;
      } else {
        yPos += 10;
      }
      
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(200, 150, 0);
      doc.text('Payment Instructions', 20, yPos);
      yPos += 10;
      
      doc.setFontSize(11);
      doc.setTextColor(0, 0, 0);
      doc.setFont(undefined, 'bold');
      const paymentNote = 'Please quote your ORN number (' + ornValue + ') when making the payment.';
      const paymentLines = doc.splitTextToSize(paymentNote, 170);
      doc.text(paymentLines, 20, yPos);
      yPos += Math.max(8, paymentLines.length * 6);
      
      doc.setFont(undefined, 'normal');
      doc.text('Pay the registration fee to:', 20, yPos);
      yPos += 8;
      
      doc.setFont(undefined, 'bold');
      doc.text('Surya: 7036216447', 20, yPos);
      yPos += 8;
      doc.text('Sai Subhakar: 8985182185', 20, yPos);
      
      // Footer
      const pageCount = doc.internal.pages.length - 1;
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(10);
        doc.setTextColor(128, 128, 128);
        doc.text('Organised by Surabhi Yuvasena, Surabhi Colony', 105, 285, { align: 'center' });
      }
      
      // Save PDF with ORN in filename
      const ornForFile = ornValue !== 'Pending' ? ornValue.replace(/[^A-Z0-9-]/g, '_') : 'Details';
      const fileName = 'Registration_' + ornForFile + '.pdf';
      console.log('Saving PDF as:', fileName);
      doc.save(fileName);
    }
    
    // Attach PDF download button handler
    document.addEventListener('DOMContentLoaded', function() {
      const downloadBtn = document.getElementById('downloadPdfBtn');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', downloadPDF);
      }
    });
    // Name validation - only alphabets
    document.getElementById('name').addEventListener('input', function(e) {
      this.value = this.value.replace(/[^A-Za-z\s]/g, '');
    });
    
    // Father name validation - only alphabets
    document.getElementById('fatherName').addEventListener('input', function(e) {
      this.value = this.value.replace(/[^A-Za-z\s]/g, '');
    });
    
    // Jersey name validation - only alphabets
    document.getElementById('jerseyName').addEventListener('input', function(e) {
      this.value = this.value.replace(/[^A-Za-z\s]/g, '');
    });
    
    // Jersey number validation - only numbers
    document.getElementById('jerseyNumber').addEventListener('input', function(e) {
      this.value = this.value.replace(/[^0-9]/g, '');
      if (this.value.length > 3) {
        this.value = this.value.slice(0, 3);
      }
    });
    
    // Mobile number validation - only digits, max 10
    document.getElementById('mobile').addEventListener('input', function(e) {
      this.value = this.value.replace(/[^0-9]/g, '');
      if (this.value.length > 10) {
        this.value = this.value.slice(0, 10);
      }
    });
    
    // Calculate registration fee based on captaincy
    document.getElementById('captaincy').addEventListener('change', function(e) {
      const feeGroup = document.getElementById('registrationFeeGroup');
      const feeDisplay = document.getElementById('registrationFee');
      const captaincy = this.value;
      
      if (captaincy) {
        feeGroup.style.display = 'block';
        const fee = captaincy === 'Yes' ? 2000 : 500;
        feeDisplay.textContent = '‚Çπ' + fee;
      } else {
        feeGroup.style.display = 'none';
      }
    });
    
    // Photo upload validation and preview
    document.getElementById('photo').addEventListener('change', function(e) {
      const file = this.files[0];
      const preview = document.getElementById('photoPreview');
      const maxSize = 10 * 1024 * 1024; // 10MB in bytes
      
      // Clear previous preview
      preview.innerHTML = '';
      preview.classList.remove('active');
      
      if (file) {
        // Check file size
        if (file.size > maxSize) {
          alert('File size exceeds 10MB. Please choose a smaller file.');
          this.value = '';
          return;
        }
        
        // Check file type
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
          alert('Invalid file type. Please upload an image file (JPG, PNG, GIF, or WebP).');
          this.value = '';
          return;
        }
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          preview.appendChild(img);
          preview.classList.add('active');
        };
        reader.readAsDataURL(file);
      }
    });
    
    // Store form data for confirmation
    let pendingFormData = null;
    let pendingPhotoBase64 = null;
    let pendingPhotoName = null;
    let pendingPhotoType = null;
    let pendingPhotoPreview = null;
    
    // Form submission - show confirmation first
    document.getElementById('registrationForm').addEventListener('submit', function(e) {
      e.preventDefault();
      console.log('=== FORM SUBMIT TRIGGERED ===');
      
      // Validate all required fields first
      const name = document.getElementById('name').value.trim();
      const fatherName = document.getElementById('fatherName').value.trim();
      const category = document.getElementById('category').value;
      const mobile = document.getElementById('mobile').value.trim();
      const captaincy = document.getElementById('captaincy').value;
      const jerseyName = document.getElementById('jerseyName').value.trim();
      const jerseyNumber = document.getElementById('jerseyNumber').value.trim();
      const tshirtSize = document.getElementById('tshirtSize').value;
      const trouserSize = document.getElementById('trouserSize').value;
      
      // Validate required fields
      if (!name) {
        alert('Please enter your name.');
        return;
      }
      if (!fatherName) {
        alert('Please enter father name.');
        return;
      }
      if (!category) {
        alert('Please select a category.');
        return;
      }
      if (!mobile || mobile.length !== 10) {
        alert('Please enter a valid 10-digit mobile number.');
        return;
      }
      if (!captaincy) {
        alert('Please select captaincy option.');
        return;
      }
      if (!jerseyName) {
        alert('Please enter jersey name.');
        return;
      }
      if (!jerseyNumber) {
        alert('Please enter jersey number.');
        return;
      }
      if (!tshirtSize) {
        alert('Please select T-shirt size.');
        return;
      }
      if (!trouserSize) {
        alert('Please select trouser size.');
        return;
      }
      
      console.log('All validations passed');
      
      // Validate photo size if provided
      const photoInput = document.getElementById('photo');
      const file = photoInput.files[0];
      const maxSize = 10 * 1024 * 1024; // 10MB
      
      if (file && file.size > maxSize) {
        alert('Photo size exceeds 10MB. Please choose a smaller file.');
        return;
      }
      
      // Calculate registration fee
      const registrationFee = captaincy === 'Yes' ? 2000 : 500;
      
      // Get all form data
      const formData = new FormData(this);
      pendingFormData = {
        name: name,
        fatherName: fatherName,
        category: category,
        mobile: mobile,
        captaincy: captaincy,
        registrationFee: registrationFee.toString(),
        jerseyName: jerseyName,
        jerseyNumber: jerseyNumber,
        tshirtSize: tshirtSize,
        trouserSize: trouserSize
      };
      
      console.log('Pending form data prepared:', pendingFormData);
      
      // Convert photo to base64 if exists
      if (file) {
        console.log('Photo file found, converting to base64...');
        const reader = new FileReader();
        reader.onload = function(e) {
          console.log('Photo converted to base64');
          pendingPhotoBase64 = e.target.result.split(',')[1];
          pendingPhotoName = file.name;
          pendingPhotoType = file.type;
          pendingPhotoPreview = e.target.result; // Full data URL for preview
          
          // Show confirmation
          console.log('Calling showConfirmation with photo...');
          showConfirmation(pendingFormData, registrationFee, pendingPhotoPreview);
        };
        reader.onerror = function(error) {
          console.error('Error reading photo:', error);
          alert('Error reading photo file. Please try again.');
        };
        reader.readAsDataURL(file);
      } else {
        console.log('No photo file, proceeding without photo...');
        pendingPhotoBase64 = '';
        pendingPhotoName = '';
        pendingPhotoType = '';
        pendingPhotoPreview = null;
        
        // Show confirmation immediately (no photo to process)
        console.log('Calling showConfirmation without photo...');
        showConfirmation(pendingFormData, registrationFee, null);
      }
    });
    
    // Show confirmation overlay
    function showConfirmation(data, fee, photoPreview) {
      console.log('showConfirmation called with data:', data);
      const overlay = document.getElementById('confirmationOverlay');
      const detailsDiv = document.getElementById('confirmationDetails');
      const feeDiv = document.getElementById('confirmationFee');
      
      if (!overlay) {
        console.error('Confirmation overlay not found!');
        return;
      }
      
      console.log('Showing confirmation overlay...');
      
      // Build confirmation details HTML
      let detailsHTML = '';
      
      if (photoPreview) {
        detailsHTML += '<div class="confirmation-photo"><img src="' + photoPreview + '" alt="Photo Preview"></div>';
      }
      
      detailsHTML += '<div class="confirmation-row">';
      detailsHTML += '<span class="confirmation-label">Name:</span>';
      detailsHTML += '<span class="confirmation-value">' + (data.name || '') + '</span>';
      detailsHTML += '</div>';
      
      detailsHTML += '<div class="confirmation-row">';
      detailsHTML += '<span class="confirmation-label">Father Name:</span>';
      detailsHTML += '<span class="confirmation-value">' + (data.fatherName || '') + '</span>';
      detailsHTML += '</div>';
      
      detailsHTML += '<div class="confirmation-row">';
      detailsHTML += '<span class="confirmation-label">Category:</span>';
      detailsHTML += '<span class="confirmation-value">' + (data.category || '') + '</span>';
      detailsHTML += '</div>';
      
      detailsHTML += '<div class="confirmation-row">';
      detailsHTML += '<span class="confirmation-label">Mobile:</span>';
      detailsHTML += '<span class="confirmation-value">' + (data.mobile || '') + '</span>';
      detailsHTML += '</div>';
      
      detailsHTML += '<div class="confirmation-row">';
      detailsHTML += '<span class="confirmation-label">Captaincy:</span>';
      detailsHTML += '<span class="confirmation-value">' + (data.captaincy || '') + '</span>';
      detailsHTML += '</div>';
      
      detailsHTML += '<div class="confirmation-row">';
      detailsHTML += '<span class="confirmation-label">Jersey Name:</span>';
      detailsHTML += '<span class="confirmation-value">' + (data.jerseyName || '') + '</span>';
      detailsHTML += '</div>';
      
      detailsHTML += '<div class="confirmation-row">';
      detailsHTML += '<span class="confirmation-label">Jersey Number:</span>';
      detailsHTML += '<span class="confirmation-value">' + (data.jerseyNumber || '') + '</span>';
      detailsHTML += '</div>';
      
      detailsHTML += '<div class="confirmation-row">';
      detailsHTML += '<span class="confirmation-label">T-shirt Size:</span>';
      detailsHTML += '<span class="confirmation-value">' + (data.tshirtSize || '') + '</span>';
      detailsHTML += '</div>';
      
      detailsHTML += '<div class="confirmation-row">';
      detailsHTML += '<span class="confirmation-label">Trouser Size:</span>';
      detailsHTML += '<span class="confirmation-value">' + (data.trouserSize || '') + '</span>';
      detailsHTML += '</div>';
      
      detailsDiv.innerHTML = detailsHTML;
      feeDiv.textContent = 'Registration Fee: ‚Çπ' + fee;
      
      overlay.classList.add('active');
    }
    
    // Go Back button - restore form data
    document.getElementById('goBackBtn').addEventListener('click', function() {
      const overlay = document.getElementById('confirmationOverlay');
      overlay.classList.remove('active');
      
      // Restore form values
      if (pendingFormData) {
        document.getElementById('name').value = pendingFormData.name || '';
        document.getElementById('fatherName').value = pendingFormData.fatherName || '';
        document.getElementById('category').value = pendingFormData.category || '';
        document.getElementById('mobile').value = pendingFormData.mobile || '';
        document.getElementById('captaincy').value = pendingFormData.captaincy || '';
        document.getElementById('jerseyName').value = pendingFormData.jerseyName || '';
        document.getElementById('jerseyNumber').value = pendingFormData.jerseyNumber || '';
        document.getElementById('tshirtSize').value = pendingFormData.tshirtSize || '';
        document.getElementById('trouserSize').value = pendingFormData.trouserSize || '';
        
        // Trigger captaincy change to show fee
        if (pendingFormData.captaincy) {
          document.getElementById('captaincy').dispatchEvent(new Event('change'));
        }
        
        // Restore photo preview if exists
        if (pendingPhotoPreview) {
          const preview = document.getElementById('photoPreview');
          preview.innerHTML = '<img src="' + pendingPhotoPreview + '" alt="Photo Preview">';
          preview.classList.add('active');
        }
      }
    });
    
    // Helper function to read iframe response with retries
    function readIframeResponseWithRetries(iframe, confirmBtn, hiddenForm, originalText, maxAttempts = 5) {
      let processed = false; // Flag to prevent multiple processing
      
      function readResponse(attempt = 1) {
        if (processed) {
          console.log('Response already processed, skipping attempt ' + attempt);
          return;
        }
        
        let responseText = '';
        let orn = null;
        let hasError = false;
        
        try {
          // First, check if iframe has loaded by checking its location
          let iframeLoaded = false;
          try {
            const iframeLocation = iframe.contentWindow.location.href;
            if (iframeLocation && iframeLocation !== 'about:blank') {
              iframeLoaded = true;
              console.log('Iframe loaded, location:', iframeLocation);
            }
          } catch (e) {
            // Can't access location - might be CORS, but also might just be loading
            console.log('Cannot access iframe location (attempt ' + attempt + '):', e.message);
            // Don't treat this as CORS error yet - might still be loading
          }
          
          let iframeDoc = null;
          let corsError = false;
          try {
            iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
          } catch (e) {
            // CORS error - cannot access iframe document
            corsError = true;
            console.log('CORS error accessing iframe document (attempt ' + attempt + '):', e.message);
            
            // Only show CORS message after many attempts AND if we're sure it's loaded
            if (attempt >= maxAttempts) {
              // After all attempts, if we still can't access, assume success
              // (Google Apps Script should have processed it)
              console.log('CORS blocking iframe access after all attempts. Registration likely successful but cannot read ORN.');
              processed = true;
              
              // Don't show alert - just show success page with note
              document.getElementById('confirmationOverlay').classList.remove('active');
              confirmBtn.textContent = originalText;
              confirmBtn.disabled = false;
              if (document.body.contains(hiddenForm)) {
                document.body.removeChild(hiddenForm);
              }
              
              // Show success page with pending ORN and note
              const successData = {
                name: pendingFormData ? pendingFormData.name : '',
                fatherName: pendingFormData ? pendingFormData.fatherName : '',
                category: pendingFormData ? pendingFormData.category : '',
                mobile: pendingFormData ? pendingFormData.mobile : '',
                captaincy: pendingFormData ? pendingFormData.captaincy : '',
                registrationFee: pendingFormData ? pendingFormData.registrationFee : '500',
                jerseyName: pendingFormData ? pendingFormData.jerseyName : '',
                jerseyNumber: pendingFormData ? pendingFormData.jerseyNumber : '',
                tshirtSize: pendingFormData ? pendingFormData.tshirtSize : '',
                trouserSize: pendingFormData ? pendingFormData.trouserSize : '',
                photoPreview: pendingPhotoPreview || null
              };
              document.getElementById('registrationForm').reset();
              document.getElementById('photoPreview').classList.remove('active');
              document.getElementById('photoPreview').innerHTML = '';
              document.getElementById('registrationFeeGroup').style.display = 'none';
              showSuccessPage(successData, null);
              
              // Add a note to the success page about ORN
              setTimeout(() => {
                const ornNote = document.createElement('div');
                ornNote.style.cssText = 'background: #fef3c7; color: #92400e; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #fbbf24;';
                ornNote.innerHTML = '<strong>üì± Note:</strong> Your registration was submitted successfully! However, we could not automatically retrieve your ORN due to browser security restrictions. Please contact the organizers with your mobile number (<strong>' + (successData.mobile || '') + '</strong>) to get your ORN.';
                const successPage = document.getElementById('successPage');
                if (successPage) {
                  const ornSection = successPage.querySelector('.detail-item:first-child');
                  if (ornSection) {
                    ornSection.parentNode.insertBefore(ornNote, ornSection.nextSibling);
                  } else {
                    successPage.appendChild(ornNote);
                  }
                }
              }, 100);
              
              pendingFormData = null;
              pendingPhotoBase64 = null;
              pendingPhotoName = null;
              pendingPhotoType = null;
              pendingPhotoPreview = null;
              return;
            }
            // Retry on CORS error (but wait longer)
            setTimeout(() => readResponse(attempt + 1), 800);
            return;
          }
          
          // If we got CORS error but haven't exhausted attempts, retry
          if (corsError && attempt < maxAttempts) {
            setTimeout(() => readResponse(attempt + 1), 800);
            return;
          }
          
          if (iframeDoc) {
            // Try different ways to get the response
            if (iframeDoc.body) {
              responseText = iframeDoc.body.textContent || iframeDoc.body.innerText || '';
            }
            if (!responseText && iframeDoc.documentElement) {
              responseText = iframeDoc.documentElement.textContent || iframeDoc.documentElement.innerText || '';
            }
            if (!responseText && iframeDoc.all) {
              responseText = iframeDoc.all[0] ? iframeDoc.all[0].textContent || iframeDoc.all[0].innerText : '';
            }
            
            // Also try to get from pre tag (common for JSON responses)
            if (!responseText) {
              const preTag = iframeDoc.querySelector('pre');
              if (preTag) {
                responseText = preTag.textContent || preTag.innerText || '';
              }
            }
          }
          
          // Clean up response - remove HTML tags if present
          if (responseText) {
            // Remove common HTML tags but keep the content
            responseText = responseText.replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '');
            responseText = responseText.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '');
            responseText = responseText.replace(/<[^>]+>/g, ' '); // Remove remaining HTML tags
            responseText = responseText.replace(/\s+/g, ' ').trim(); // Normalize whitespace
          }
          
          console.log('Attempt ' + attempt + ' - Full iframe response:', responseText);
          console.log('Response length:', responseText.length);
          console.log('Response preview (first 500 chars):', responseText.substring(0, 500));
          
          if (responseText && responseText.trim().length > 0) {
            // FIRST: Check for error messages (before trying to extract ORN)
            const lowerResponse = responseText.toLowerCase();
            if (responseText.includes('Error:') || lowerResponse.includes('error') || responseText.includes('already registered')) {
              hasError = true;
              let errorMessage = '';
              
              // Check for duplicate mobile number error
              if (responseText.includes('already registered') || responseText.includes('mobile number is already')) {
                errorMessage = 'This mobile number is already registered. Please use a different mobile number or contact the organizers.';
              } else {
                // Try to extract error message
                const errorMatch = responseText.match(/Error: ([^\n|]+)/i);
                if (errorMatch) {
                  errorMessage = errorMatch[1].trim();
                } else {
                  errorMessage = responseText.substring(0, 200); // First 200 chars
                }
              }
              
              console.log('Error detected:', errorMessage);
              
              // Show error alert with clear message
              alert('Registration Error:\n\n' + errorMessage + '\n\nPlease correct the issue and try again.');
              
              // Close overlay and re-enable button
              document.getElementById('confirmationOverlay').classList.remove('active');
              confirmBtn.textContent = originalText;
              confirmBtn.disabled = false;
              
              // Remove form
              if (document.body.contains(hiddenForm)) {
                document.body.removeChild(hiddenForm);
              }
              
              return; // Stop processing - don't show success page
            }
            
            // Check if response is JSON
            try {
              const response = JSON.parse(responseText);
              if (response.success === false || response.error) {
                hasError = true;
                const errorMsg = response.error || response.message || 'Registration failed';
                alert('Registration Error:\n\n' + errorMsg + '\n\nPlease correct the issue and try again.');
                document.getElementById('confirmationOverlay').classList.remove('active');
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
                if (document.body.contains(hiddenForm)) {
                  document.body.removeChild(hiddenForm);
                }
                return;
              } else if (response.success === true && response.orn) {
                // Success with ORN in JSON
                orn = response.orn;
                console.log('ORN received from JSON:', orn);
              }
            } catch (e) {
              // Not JSON, try to extract ORN from text
              console.log('Response is not JSON, trying to extract ORN from text');
            }
            
            // Extract ORN from text if not found in JSON
            if (!orn) {
              // Try multiple patterns for ORN (order matters - most specific first)
              const ornPatterns = [
                /"orn"\s*:\s*"([^"]+)"/i,  // "orn": "ORN-20251112-0001" (JSON in text)
                /'orn'\s*:\s*'([^']+)'/i,  // 'orn': 'ORN-20251112-0001'
                /ORN[:\s]+([A-Z0-9-]+)/i,  // ORN: ORN-20251112-0001
                /(ORN-\d{8}-\d{4})/i,  // ORN-20251112-0001 (direct match with capture group)
                /(ORN[-\s]?\d{8}[-\s]?\d{4})/i  // Flexible pattern
              ];
              
              for (let pattern of ornPatterns) {
                const match = responseText.match(pattern);
                if (match) {
                  // Use capture group if available, otherwise use full match
                  orn = (match[1] || match[0]).trim();
                  // Clean up ORN format - ensure proper format
                  orn = orn.replace(/[\s_]/g, '-').toUpperCase();
                  // Validate ORN format
                  if (/^ORN-\d{8}-\d{4}$/.test(orn)) {
                    console.log('ORN extracted and validated with pattern:', pattern, 'Result:', orn);
                    break;
                  } else {
                    console.log('ORN extracted but format invalid:', orn, 'trying next pattern...');
                    orn = null; // Reset and try next pattern
                  }
                }
              }
              
              // Last resort: find any ORN-like pattern and clean it up
              if (!orn) {
                const anyOrnMatch = responseText.match(/(ORN[-\s]?\d{8}[-\s]?\d{4})/i);
                if (anyOrnMatch) {
                  orn = anyOrnMatch[1].replace(/[\s_]/g, '-').toUpperCase();
                  // Try to fix format if close
                  orn = orn.replace(/ORN-?(\d{8})-?(\d{4})/i, 'ORN-$1-$2');
                  console.log('ORN found with flexible pattern and cleaned:', orn);
                }
              }
            }
            
            // If we got a response and found ORN or no error, process it
            if (orn || (!hasError && responseText.length > 0)) {
              processed = true; // Mark as processed to prevent duplicate calls
              processSuccess(orn, hasError);
              return;
            }
          }
        } catch (e) {
          console.log('Error reading iframe (attempt ' + attempt + '):', e);
        }
        
        // If no response yet and we have more attempts, retry
        if (attempt < maxAttempts && (!responseText || responseText.trim().length === 0)) {
          console.log('No response yet, retrying in 500ms... (attempt ' + attempt + '/' + maxAttempts + ')');
          setTimeout(() => readResponse(attempt + 1), 500);
          return;
        }
        
        // If we exhausted attempts and still no response, assume success but no ORN
        if (attempt >= maxAttempts && !processed) {
          console.log('Max attempts reached, processing without ORN');
          processed = true; // Mark as processed
          processSuccess(null, false);
        }
      }
      
      // Start with a small delay to let iframe load
      setTimeout(() => readResponse(1), 300);
      
      // Function to process successful registration
      function processSuccess(orn, hasError) {
        if (hasError) {
          return; // Already handled above
        }
        
        console.log('Final ORN value:', orn);
        
        // Prepare data for success page - use actual form data
        const successData = {
          name: pendingFormData ? pendingFormData.name : '',
          fatherName: pendingFormData ? pendingFormData.fatherName : '',
          category: pendingFormData ? pendingFormData.category : '',
          mobile: pendingFormData ? pendingFormData.mobile : '',
          captaincy: pendingFormData ? pendingFormData.captaincy : '',
          registrationFee: pendingFormData ? pendingFormData.registrationFee : '500',
          jerseyName: pendingFormData ? pendingFormData.jerseyName : '',
          jerseyNumber: pendingFormData ? pendingFormData.jerseyNumber : '',
          tshirtSize: pendingFormData ? pendingFormData.tshirtSize : '',
          trouserSize: pendingFormData ? pendingFormData.trouserSize : '',
          photoPreview: pendingPhotoPreview || null
        };
        
        console.log('Success data prepared:', successData);
        console.log('ORN to display:', orn);
        
        // Close overlay
        document.getElementById('confirmationOverlay').classList.remove('active');
        
        // Reset form
        document.getElementById('registrationForm').reset();
        document.getElementById('photoPreview').classList.remove('active');
        document.getElementById('photoPreview').innerHTML = '';
        document.getElementById('registrationFeeGroup').style.display = 'none';
        
        // Show success page with ORN
        showSuccessPage(successData, orn);
    
        // Clear pending data
        pendingFormData = null;
        pendingPhotoBase64 = null;
        pendingPhotoName = null;
        pendingPhotoType = null;
        pendingPhotoPreview = null;
        
        // Remove form
        if (document.body.contains(hiddenForm)) {
          document.body.removeChild(hiddenForm);
        }
        
        confirmBtn.textContent = originalText;
        confirmBtn.disabled = false;
      }
      
      // Note: readResponse is called with delay in the function above
    }
    
    // Wait for DOM to be ready, then attach event listeners
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, attaching event listeners...');
      
      const confirmBtn = document.getElementById('confirmBtn');
      if (!confirmBtn) {
        console.error('Confirm button not found!');
        return;
      }
      console.log('Confirm button found, attaching click handler...');
      
      confirmBtn.addEventListener('click', function() {
      console.log('Confirm button clicked!');
      console.log('Pending form data:', pendingFormData);
      
      if (!pendingFormData) {
        console.error('No pending form data!');
        alert('Error: No form data to submit. Please fill out the form again.');
        return;
      }
      
      const confirmBtn = this;
      const originalText = confirmBtn.textContent;
      confirmBtn.textContent = 'Submitting...';
      confirmBtn.disabled = true;
      
      console.log('Starting submission process...');
      
      // Prepare submission data
      const submissionData = {
        name: pendingFormData.name || '',
        fatherName: pendingFormData.fatherName || '',
        category: pendingFormData.category || '',
        mobile: pendingFormData.mobile || '',
        captaincy: pendingFormData.captaincy || '',
        registrationFee: pendingFormData.registrationFee || '',
        jerseyName: pendingFormData.jerseyName || '',
        jerseyNumber: pendingFormData.jerseyNumber || '',
        tshirtSize: pendingFormData.tshirtSize || '',
        trouserSize: pendingFormData.trouserSize || '',
        photo: pendingPhotoBase64 || '',
        photoName: pendingPhotoName || '',
        photoType: pendingPhotoType || ''
      };
      
      // Log what we're sending (for debugging)
      console.log('=== FORM SUBMISSION START ===');
      console.log('Submitting data:', {
        name: submissionData.name,
        mobile: submissionData.mobile,
        category: submissionData.category,
        photoSize: submissionData.photo ? submissionData.photo.length + ' chars' : 'no photo'
      });
      console.log('Google Script URL:', GOOGLE_SCRIPT_URL);
      
      // Check if photo is too large (base64 can be very long)
      const photoSize = submissionData.photo ? submissionData.photo.length : 0;
      if (photoSize > 5000000) { // ~5MB base64 = ~3.75MB actual file
        alert('Photo is too large. Please use a smaller image (under 5MB).');
        confirmBtn.textContent = originalText;
        confirmBtn.disabled = false;
        return;
      }
      
      // Submit to Google Apps Script
      // Use traditional form submission instead of fetch with no-cors
      // This ensures POST data is sent properly to Google Apps Script
      console.log('Sending form submission to:', GOOGLE_SCRIPT_URL);
      console.log('Submitting data:', {
        name: submissionData.name,
        mobile: submissionData.mobile,
        category: submissionData.category,
        photoSize: submissionData.photo ? submissionData.photo.length + ' chars' : 'no photo'
      });
      
      const hiddenForm = document.createElement('form');
      hiddenForm.method = 'POST';
      hiddenForm.action = GOOGLE_SCRIPT_URL;
      hiddenForm.target = 'hiddenIframe';
      hiddenForm.style.display = 'none';
      
      // Add all form fields as hidden inputs
      Object.keys(submissionData).forEach(key => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = submissionData[key];
        hiddenForm.appendChild(input);
      });
      
      // Create hidden iframe to receive response
      let iframe = document.getElementById('hiddenIframe');
      if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.id = 'hiddenIframe';
        iframe.name = 'hiddenIframe';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
      }
      
      // Add form to body and submit
      document.body.appendChild(hiddenForm);
      
      console.log('Hidden form created with', Object.keys(submissionData).length, 'fields');
      console.log('Form action:', hiddenForm.action);
      console.log('Submitting form now...');
      
          // Handle iframe load (response received)
          iframe.onload = function() {
            console.log('=== FORM SUBMISSION COMPLETED ===');
            console.log('Iframe loaded - response received from server');
            console.log('Form submitted, waiting for processing...');
            
            // Use helper function to read response with retries
            readIframeResponseWithRetries(iframe, confirmBtn, hiddenForm, originalText);
          };
      
      // Submit form
      hiddenForm.submit();
      
      // Fallback timeout in case iframe doesn't load
      setTimeout(function() {
        if (confirmBtn.disabled) {
          console.log('Submission timeout, assuming success...');
          
          // Prepare data for success page
          const successData = pendingFormData || {
            name: '',
            fatherName: '',
            category: '',
            mobile: '',
            captaincy: '',
            registrationFee: '500',
            jerseyName: '',
            jerseyNumber: '',
            tshirtSize: '',
            trouserSize: '',
            photoPreview: pendingPhotoPreview || null
          };
          
          document.getElementById('confirmationOverlay').classList.remove('active');
          document.getElementById('registrationForm').reset();
          document.getElementById('photoPreview').classList.remove('active');
          document.getElementById('photoPreview').innerHTML = '';
          document.getElementById('registrationFeeGroup').style.display = 'none';
          
          // Show success page (without ORN since we couldn't get it)
          showSuccessPage(successData, null);
          
          pendingFormData = null;
          pendingPhotoBase64 = null;
          pendingPhotoName = null;
          pendingPhotoType = null;
          pendingPhotoPreview = null;
          
          if (document.body.contains(hiddenForm)) {
            document.body.removeChild(hiddenForm);
          }
          
          confirmBtn.textContent = originalText;
          confirmBtn.disabled = false;
        }
      }, 5000);
      });
    });
    
    // Also attach immediately if DOM is already loaded
    if (document.readyState === 'loading') {
      // DOM is still loading, wait for DOMContentLoaded (handled above)
    } else {
      // DOM is already loaded, attach immediately
      console.log('DOM already loaded, attaching event listeners immediately...');
      const confirmBtn = document.getElementById('confirmBtn');
      if (confirmBtn) {
        console.log('Confirm button found, attaching click handler...');
        confirmBtn.addEventListener('click', function() {
          console.log('Confirm button clicked!');
          console.log('Pending form data:', pendingFormData);
          
          if (!pendingFormData) {
            console.error('No pending form data!');
            alert('Error: No form data to submit. Please fill out the form again.');
            return;
          }
          
          const confirmBtn = this;
          const originalText = confirmBtn.textContent;
          confirmBtn.textContent = 'Submitting...';
          confirmBtn.disabled = true;
          
          console.log('Starting submission process...');
          
          // Prepare submission data
          const submissionData = {
            name: pendingFormData.name || '',
            fatherName: pendingFormData.fatherName || '',
            category: pendingFormData.category || '',
            mobile: pendingFormData.mobile || '',
            captaincy: pendingFormData.captaincy || '',
            registrationFee: pendingFormData.registrationFee || '',
            jerseyName: pendingFormData.jerseyName || '',
            jerseyNumber: pendingFormData.jerseyNumber || '',
            tshirtSize: pendingFormData.tshirtSize || '',
            trouserSize: pendingFormData.trouserSize || '',
            photo: pendingPhotoBase64 || '',
            photoName: pendingPhotoName || '',
            photoType: pendingPhotoType || ''
          };
          
          // Log what we're sending (for debugging)
          console.log('=== FORM SUBMISSION START ===');
          console.log('Submitting data:', {
            name: submissionData.name,
            mobile: submissionData.mobile,
            category: submissionData.category,
            photoSize: submissionData.photo ? submissionData.photo.length + ' chars' : 'no photo'
          });
          console.log('Google Script URL:', GOOGLE_SCRIPT_URL);
          
          // Check if photo is too large (base64 can be very long)
          const photoSize = submissionData.photo ? submissionData.photo.length : 0;
          if (photoSize > 5000000) { // ~5MB base64 = ~3.75MB actual file
            alert('Photo is too large. Please use a smaller image (under 5MB).');
            confirmBtn.textContent = originalText;
            confirmBtn.disabled = false;
            return;
          }
          
          // Submit to Google Apps Script
          // Use FormData for better handling of large data
          const formDataToSend = new URLSearchParams();
          Object.keys(submissionData).forEach(key => {
            formDataToSend.append(key, submissionData[key]);
          });
          
          console.log('Sending form submission to:', GOOGLE_SCRIPT_URL);
          console.log('Request body length:', formDataToSend.toString().length);
          console.log('Request body preview (first 200 chars):', formDataToSend.toString().substring(0, 200));
          
          // Use traditional form submission instead of fetch with no-cors
          // This ensures POST data is sent properly to Google Apps Script
          const hiddenForm = document.createElement('form');
          hiddenForm.method = 'POST';
          hiddenForm.action = GOOGLE_SCRIPT_URL;
          hiddenForm.target = 'hiddenIframe';
          hiddenForm.style.display = 'none';
          
          // Add all form fields as hidden inputs
          Object.keys(submissionData).forEach(key => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = submissionData[key];
            hiddenForm.appendChild(input);
          });
          
          // Create hidden iframe to receive response
          let iframe = document.getElementById('hiddenIframe');
          if (!iframe) {
            iframe = document.createElement('iframe');
            iframe.id = 'hiddenIframe';
            iframe.name = 'hiddenIframe';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
          }
          
          // Add form to body and submit
          document.body.appendChild(hiddenForm);
          
          console.log('Hidden form created with', Object.keys(submissionData).length, 'fields');
          console.log('Form action:', hiddenForm.action);
          console.log('Submitting form now...');
          
          // Handle iframe load (response received)
          iframe.onload = function() {
            console.log('=== FORM SUBMISSION COMPLETED ===');
            console.log('Iframe loaded - response received from server');
            console.log('Form submitted, waiting for processing...');
            
            // Use helper function to read response with retries
            readIframeResponseWithRetries(iframe, confirmBtn, hiddenForm, originalText);
          };
          
          // Submit form
          hiddenForm.submit();
          
          // Fallback timeout in case iframe doesn't load
          setTimeout(function() {
            if (confirmBtn.disabled) {
              console.log('Submission timeout, assuming success...');
              
              // Prepare data for success page
              const successData = pendingFormData || {
                name: '',
                fatherName: '',
                category: '',
                mobile: '',
                captaincy: '',
                registrationFee: '500',
                jerseyName: '',
                jerseyNumber: '',
                tshirtSize: '',
                trouserSize: '',
                photoPreview: pendingPhotoPreview || null
              };
              
              document.getElementById('confirmationOverlay').classList.remove('active');
              document.getElementById('registrationForm').reset();
              document.getElementById('photoPreview').classList.remove('active');
              document.getElementById('photoPreview').innerHTML = '';
              document.getElementById('registrationFeeGroup').style.display = 'none';
              
              // Show success page (without ORN since we couldn't get it)
              showSuccessPage(successData, null);
              
              pendingFormData = null;
              pendingPhotoBase64 = null;
              pendingPhotoName = null;
              pendingPhotoType = null;
              pendingPhotoPreview = null;
              
              if (document.body.contains(hiddenForm)) {
                document.body.removeChild(hiddenForm);
              }
              
              confirmBtn.textContent = originalText;
              confirmBtn.disabled = false;
            }
          }, 5000);
        });
      } else {
        console.error('Confirm button not found when trying to attach handler!');
      }
    }
  </script>
</body>
</html>

