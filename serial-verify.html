<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
  <title>Serial Number Verification - Surabhi Premier League 2025</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      background: #0f172a;
      color: #e2e8f0;
      font-family: system-ui, Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .container {
      max-width: 500px;
      width: 100%;
      background: #111827;
      border: 2px solid #334155;
      border-radius: 16px;
      padding: clamp(20px, 4vw, 40px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      font-size: clamp(24px, 5vw, 32px);
      margin-bottom: 10px;
      color: #60a5fa;
      font-weight: 700;
      text-align: center;
    }
    
    .subtitle {
      text-align: center;
      color: #94a3b8;
      margin-bottom: 30px;
      font-size: clamp(14px, 2.5vw, 16px);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #e2e8f0;
      font-weight: 500;
      font-size: clamp(14px, 2.5vw, 16px);
    }
    
    input[type="text"],
    input[type="email"],
    input[type="number"] {
      width: 100%;
      padding: 12px 16px;
      background: #1e293b;
      border: 2px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      font-size: clamp(14px, 2.5vw, 16px);
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    
    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: #60a5fa;
    }
    
    .help-text {
      display: block;
      margin-top: 6px;
      font-size: clamp(12px, 2vw, 14px);
      color: #64748b;
    }
    
    .submit-btn {
      width: 100%;
      padding: clamp(12px, 2vh, 16px) clamp(24px, 4vw, 32px);
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: clamp(14px, 3vw, 18px);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .submit-btn:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
    }
    
    .submit-btn:active {
      transform: translateY(0);
    }
    
    .submit-btn:disabled {
      background: #475569;
      cursor: not-allowed;
      transform: none;
    }
    
    .status-message {
      margin-top: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: clamp(14px, 2.5vw, 16px);
      text-align: center;
      display: none;
    }
    
    .status-message.success {
      background: #065f46;
      color: #6ee7b7;
      border: 1px solid #10b981;
      display: block;
    }
    
    .status-message.error {
      background: #7f1d1d;
      color: #fca5a5;
      border: 1px solid #ef4444;
      display: block;
    }
    
    .back-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      color: #60a5fa;
      text-decoration: none;
      font-size: clamp(14px, 2.5vw, 16px);
    }
    
    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Serial Number Verification</h1>
    <p class="subtitle">Enter your serial number and email to continue registration</p>
    
    <form id="serialForm">
      <div class="form-group">
        <label for="serialNumber">Serial Number *</label>
        <input type="number" id="serialNumber" name="serialNumber" required min="1" autocomplete="off">
        <small class="help-text">Enter the serial number provided by organizers</small>
      </div>
      
      <div class="form-group">
        <label for="email">Email Address *</label>
        <input type="email" id="email" name="email" required autocomplete="email">
        <small class="help-text">Enter the email address used during payment</small>
      </div>
      
      <button type="submit" id="verifyBtn" class="submit-btn">Verify Serial Number</button>
      
      <div id="statusMessage" class="status-message"></div>
    </form>
    
    <a href="index.html" class="back-link">‚Üê Back to Home</a>
  </div>
  
  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxY-Hoq9xCwO2i_rixEmDzThNVe8m4yDLWhAewhM9Vs8fq4TFYbNRAff87-0E9sR2NQ/exec';
    
    function showStatus(message, isError = false) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = message;
      statusDiv.className = 'status-message ' + (isError ? 'error' : 'success');
      statusDiv.style.display = 'block';
    }
    
    function hideStatus() {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.style.display = 'none';
      statusDiv.className = 'status-message';
    }
    
    document.getElementById('serialForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const serialNumber = document.getElementById('serialNumber').value.trim();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const verifyBtn = document.getElementById('verifyBtn');
      
      if (!serialNumber || !email) {
        showStatus('Please enter both serial number and email address.', true);
        return;
      }
      
      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showStatus('Please enter a valid email address.', true);
        return;
      }
      
      verifyBtn.disabled = true;
      verifyBtn.textContent = 'Verifying...';
      hideStatus();
      
      try {
        // Since we're using no-cors, we can't read the response directly
        // We'll use a hidden iframe to get the response
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.name = 'hiddenFrame';
        iframe.id = 'serialCheckIframe';
        document.body.appendChild(iframe);
        
        console.log('Iframe created, waiting for it to load...');
        
        const form = document.createElement('form');
        form.method = 'GET';
        form.action = GOOGLE_SCRIPT_URL;
        form.target = 'hiddenFrame';
        
        // Create form inputs with correct names
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'checkSerial';
        form.appendChild(actionInput);
        
        const serialInput = document.createElement('input');
        serialInput.type = 'hidden';
        serialInput.name = 'serialNumber';
        serialInput.value = serialNumber;
        form.appendChild(serialInput);
        
        const emailInput = document.createElement('input');
        emailInput.type = 'hidden';
        emailInput.name = 'email';
        emailInput.value = email;
        form.appendChild(emailInput);
        
        // Log the form data being sent
        console.log('Form data being sent:', {
          action: 'checkSerial',
          serialNumber: serialNumber,
          email: email
        });
        
        document.body.appendChild(form);
        
        // Set up postMessage listener BEFORE submitting form
        let postMessageReceived = false;
        let messageHandler = null;
        
        messageHandler = function(event) {
          // Log all messages for debugging
          console.log('üîç MessageHandler received:', {
            origin: event.origin,
            data: event.data,
            dataType: typeof event.data,
            hasType: event.data && event.data.type,
            typeValue: event.data && event.data.type
          });
          
          // Filter out browser extension messages (they have different origins)
          // Only process messages that look like our serial check response
          if (!event.data || typeof event.data !== 'object') {
            console.log('‚è≠Ô∏è Ignoring non-object message');
            return; // Ignore non-object messages (likely from extensions)
          }
          
          // Check if this is our serial check message
          // Accept from any origin (since Google Apps Script might use different origins)
          if (event.data && event.data.type === 'serialCheck') {
            postMessageReceived = true;
            console.log('‚úÖ‚úÖ‚úÖ RECEIVED postMessage from Google Apps Script!', event.data);
            console.log('Origin:', event.origin);
            
            // Remove listener immediately to prevent duplicate processing
            if (messageHandler) {
              window.removeEventListener('message', messageHandler);
            }
            if (debugMessageHandler) {
              window.removeEventListener('message', debugMessageHandler);
            }
            
            if (event.data.success) {
              // Store data in sessionStorage
              sessionStorage.setItem('verifiedSerial', serialNumber);
              sessionStorage.setItem('verifiedEmail', email);
              sessionStorage.setItem('paymentAmount', event.data.amount || '');
              sessionStorage.setItem('paymentToWhom', event.data.toWhom || '');
              
              console.log('‚úÖ Stored in sessionStorage:', {
                serial: serialNumber,
                email: email,
                amount: event.data.amount,
                toWhom: event.data.toWhom
              });
              
              // Clean up
              if (document.body.contains(form)) document.body.removeChild(form);
              if (document.body.contains(iframe)) document.body.removeChild(iframe);
              
              // Redirect to email verification page
              setTimeout(() => {
                window.location.href = 'email-verify.html';
              }, 100);
            } else {
              const errorMsg = event.data.error || 'Verification failed. Please try again.';
              console.error('‚ùå Verification failed:', errorMsg);
              showStatus(errorMsg, true);
              verifyBtn.disabled = false;
              verifyBtn.textContent = 'Verify Serial Number';
              if (document.body.contains(form)) document.body.removeChild(form);
              if (document.body.contains(iframe)) document.body.removeChild(iframe);
            }
          } else {
            console.log('‚è≠Ô∏è Ignoring message - not a serialCheck type. Type:', event.data && event.data.type);
          }
        };
        
        // Add message listener
        window.addEventListener('message', messageHandler);
        console.log('üì° PostMessage listener added, waiting for response...');
        console.log('Submitting form to:', GOOGLE_SCRIPT_URL);
        console.log('Serial Number:', serialNumber);
        console.log('Email:', email);
        
        // Also log ALL postMessages received (for debugging)
        const debugMessageHandler = function(event) {
          console.log('üîç DEBUG: Received postMessage from:', event.origin);
          console.log('üîç DEBUG: Message data:', event.data);
          console.log('üîç DEBUG: Message type:', typeof event.data);
        };
        window.addEventListener('message', debugMessageHandler);
        
        // Fallback timeout in case postMessage doesn't arrive
        setTimeout(function() {
          if (!postMessageReceived) {
            console.log('‚è∞ PostMessage timeout after 5 seconds - trying to read iframe response as fallback');
            console.log('This might be a CORS issue. Checking iframe...');
            
            try {
              const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
              const responseText = iframeDoc.body ? iframeDoc.body.textContent || iframeDoc.body.innerText : '';
              
              console.log('Fallback response from server:', responseText);
              
              if (responseText && (responseText.includes('success:') || responseText.includes('verified'))) {
                // Extract amount and to whom from response
                const amountMatch = responseText.match(/amount[:\s]+‚Çπ?(\d+)/i);
                const amount = amountMatch ? amountMatch[1] : '';
                const toWhomMatch = responseText.match(/to whom[:\s]+([^,\n]+)/i);
                const toWhom = toWhomMatch ? toWhomMatch[1].trim() : '';
                
                console.log('Extracted from response - Amount:', amount, 'To Whom:', toWhom);
                
                // Store serial number, email, amount, and to whom in sessionStorage
                sessionStorage.setItem('verifiedSerial', serialNumber);
                sessionStorage.setItem('verifiedEmail', email);
                sessionStorage.setItem('paymentAmount', amount);
                sessionStorage.setItem('paymentToWhom', toWhom);
                
                // Clean up
                window.removeEventListener('message', messageHandler);
                if (document.body.contains(form)) document.body.removeChild(form);
                if (document.body.contains(iframe)) document.body.removeChild(iframe);
                
                // Redirect to email verification page
                window.location.href = 'email-verify.html';
                return;
              } else if (responseText && (responseText.includes('error:') || responseText.includes('not found') || responseText.includes('mismatch'))) {
                const errorMsg = responseText.includes('mismatch') 
                  ? 'Email address does not match the serial number. Please check and try again.'
                  : responseText.includes('not found')
                  ? 'Serial number not found. Please check your serial number or contact organizers.'
                  : 'Verification failed: ' + responseText;
                console.error('Error from server:', errorMsg);
                showStatus(errorMsg, true);
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify Serial Number';
                window.removeEventListener('message', messageHandler);
                if (document.body.contains(form)) document.body.removeChild(form);
                if (document.body.contains(iframe)) document.body.removeChild(iframe);
                return;
              } else {
                // No response text or empty response
                console.log('No response text found in iframe');
              }
            } catch (error) {
              // CORS error - this is expected when trying to read cross-origin iframe
              console.log('CORS error reading iframe (expected for cross-origin):', error.message);
            }
            
            // If we get here, postMessage didn't arrive and iframe reading failed
            if (!postMessageReceived) {
              console.error('Both postMessage and iframe reading failed. Serial:', serialNumber, 'Email:', email);
              showStatus('Could not verify serial number. Please ensure:\n1. Serial number is correct\n2. Email matches the one used during payment\n3. Try refreshing the page and try again\n\nIf the problem persists, contact organizers.', true);
              verifyBtn.disabled = false;
              verifyBtn.textContent = 'Verify Serial Number';
              window.removeEventListener('message', messageHandler);
              if (document.body.contains(form)) document.body.removeChild(form);
              if (document.body.contains(iframe)) document.body.removeChild(iframe);
            }
          } else {
            console.log('PostMessage was received, no fallback needed');
          }
        }, 5000); // Wait 5 seconds for postMessage
        
        // Also add iframe onload handler as backup
        iframe.onload = function() {
          console.log('‚úÖ Iframe loaded successfully');
          console.log('Iframe src:', iframe.src);
          console.log('Iframe contentWindow:', iframe.contentWindow);
          
          // Try to check iframe content after a delay
          setTimeout(function() {
            if (!postMessageReceived) {
              console.log('‚ö†Ô∏è Iframe loaded but postMessage not received yet. This might mean:');
              console.log('1. Google Apps Script needs to be redeployed');
              console.log('2. The checkSerial function is not working');
              console.log('3. There is a permissions issue');
              console.log('4. The script URL might be incorrect');
              
              // Try to get iframe URL
              try {
                const iframeUrl = iframe.contentWindow.location.href;
                console.log('Iframe URL:', iframeUrl);
                
                // Try to access iframe document to see if script ran
                try {
                  const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                  const bodyText = iframeDoc.body ? iframeDoc.body.textContent || iframeDoc.body.innerText : '';
                  console.log('Iframe body text (first 500 chars):', bodyText.substring(0, 500));
                  
                  // Check if script tag exists
                  const scripts = iframeDoc.getElementsByTagName('script');
                  console.log('Number of script tags in iframe:', scripts.length);
                } catch (docError) {
                  console.log('Cannot access iframe document (CORS):', docError.message);
                }
              } catch (e) {
                console.log('Cannot access iframe URL (CORS):', e.message);
              }
            }
          }, 3000); // Increased to 3 seconds
        };
        
        iframe.onerror = function() {
          console.error('‚ùå Iframe failed to load');
          showStatus('Failed to connect to verification server. Please check your internet connection and try again.', true);
          verifyBtn.disabled = false;
          verifyBtn.textContent = 'Verify Serial Number';
        };
        
        // Submit form
        console.log('üöÄ Submitting form now...');
        console.log('Form action URL:', form.action);
        console.log('Form target:', form.target);
        console.log('Form method:', form.method);
        
        // Add a small delay to ensure iframe is ready
        setTimeout(() => {
          form.submit();
          console.log('‚úÖ Form submitted, iframe should load soon...');
        }, 100);
        
      } catch (error) {
        console.error('Error:', error);
        showStatus('Error verifying serial number. Please try again.', true);
        verifyBtn.disabled = false;
        verifyBtn.textContent = 'Verify Serial Number';
      }
    });
  </script>
</body>
</html>

